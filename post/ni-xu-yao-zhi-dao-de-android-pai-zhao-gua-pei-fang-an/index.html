<html>
      <head>
        <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1,user-scalable=no" />
        <meta charset="utf-8">
        <meta name="referrer" content="never">
        <title>你需要知道的Android拍照适配方案 | 浩浩的博客</title>
        <link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.11.1/katex.min.css">
        <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://fqzhanghao.github.io//styles/main.css">
          <script src="https://fqzhanghao.github.io//media/scripts/mdui.min.js"></script>
        <link rel="stylesheet" href="https://at.alicdn.com/t/font_1306644_jwtuc2zzbrd.css">
        <link href="https://fonts.googleapis.com/css?family=Dancing+Script|Ma+Shan+Zheng&display=swap" rel="stylesheet">
        <script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
        <script src="https://fqzhanghao.github.io//media/scripts/script.js"></script>
        <script >hljs.initHighlightingOnLoad();</script>
        

    </head>
    <body class="mdui-theme-primary-purple mdui-theme-accent-purple">
        <header class="index-img mdui-m-b-3" >
                          <button class="mdui-btn  mdui-btn-icon mdui-btn-dense mdui-color-theme-500 mdui-ripple yinying mdui-m-t-1 mdui-m-l-1" mdui-menu="{target: '#demo-attr-cascade'}"><i class="mdui-icon material-icons">&#xe5d2;</i></button>
                <ul class="mdui-menu" id="demo-attr-cascade">
                
                        <li class="mdui-menu-item">
                          <a href="/" class="mdui-ripple">首页</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/archives" class="mdui-ripple">归档</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/post/about" class="mdui-ripple">关于</a>
                        </li>
                
                      </ul>

        </header>
        <div class="mdui-container post">
                <div class="mdui-row">
                        <div class="mdui-col-md-8 mdui-col-offset-md-2 ">
                         <article class="mdui-shadow-10 mdui-p-a-2 post-list">
                           <div class="mdui-typo-display-1 mdui-m-b-3">你需要知道的Android拍照适配方案</div>
                           <a  class="index-list-biaoqian ">2020-01-19</a>
                           <div class="mdui-typo mdui-m-t-3 post-neirong"><p>转自:<a href="http://www.jianshu.com/p/f269bcda335f">http://www.jianshu.com/p/f269bcda335f</a></p>
<!--more-->
<h3 id="拍照功能实现">拍照功能实现</h3>
<p>Android 程序上实现拍照功能的方式分为两种：第一种是利用相机的 API 来自定义相机，第二种是利用 Intent 调用系统指定的相机拍照。下面讲的内容都是针对第二种实现方式的适配。</p>
<p>通常情况下，我们调用拍照的业务场景是如下面这样的：</p>
<ol>
<li>A 界面，点击按钮调用相机拍照；</li>
<li>A 界面得到拍完照片，跳转到 B 界面进行预览；</li>
<li>B 界面有个按钮，点击后触发某个业务流程来处理这张照片；</li>
</ol>
<p>实现的大体流程代码如下：</p>
<figure data-type="image" tabindex="1"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119201732.png" alt="" loading="lazy"></figure>
<p>到这里基本科普完了如何调用系统相机拍照，相信这些网上一搜一大把的代码，很多童鞋都能看懂。</p>
<h3 id="有没有相机可用">有没有相机可用？</h3>
<p>前面讲到我们是调用系统指定的相机app来拍照，那么系统是否存在可以被我们调用的app呢？这个我们不敢确定，毕竟 Android 奇葩问题多，还真有遇到过这种极端的情况导致闪退的。虽然很极端，但作为客户端人员还是要进行处理，方式有二：</p>
<ol>
<li>调用相机时，简单粗暴的 try-catch</li>
<li>调用相机前，检测系统有没有相机 app 可用</li>
</ol>
<p>try-catch 这种粗暴的方式大家肯定很熟悉了，那么要如何检测系统有没有相机 app 可用呢？系统在  PackageManager 里为我们提供这样一个 API</p>
<figure data-type="image" tabindex="2"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119201748.png" alt="" loading="lazy"></figure>
<p>通过这样一个 API ，可以知道系统是否存在 action 为 MediaStore.ACTION_IMAGE_CAPTURE 的 intent 可以唤起的拍照界面，具体实现代码如下：</p>
<figure data-type="image" tabindex="3"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119201759.png" alt="" loading="lazy"></figure>
<h3 id="拍出来的照片歪了">拍出来的照片“歪了”！！！</h3>
<p>经常会遇到一种情况，拍照时看到照片是正的，但是当我们的 app 获取到这张照片时，却发现旋转了 90 度（也有可能是180、270，不过90度比较多见，貌似都是由于手机传感器导致的）。很多童鞋对此感到很困扰，因为不是所有手机都会出现这种情况，就算会是出现这种情况的手机上，也并非每次必现。要怎么解决这个问题呢？从解决的思路上看，只要获取到照片旋转的角度，利用 Matrix 来进行角度纠正即可。那么问题来了，要怎么知道照片旋转的角度呢？细心的童鞋可能会发现，拍完一张照片去到相册点击属性查看，能看到下面这样一堆关于照片的属性数据<br>
<img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119201809.png" alt="" loading="lazy"></p>
<p>没错，这里面就有一个旋转角度，倘若拍照后保存的成像照片文件发生了角度旋转，这个图片的属性参数就能告诉我们到底旋转了多少度。只要获取到这个角度值，我们就能进行纠正的工作了。 Android 系统提供了 ExifInterface 类来满足获取图片各个属性的操作<br>
<img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119201818.png" alt="" loading="lazy"></p>
<p>通过 ExifInterface 类拿到 TAG_ORIENTATION 属性对应的值，即为我们想要得到旋转角度。再根据利用 Matrix 进行旋转纠正即可。实现代码大致如下：</p>
<figure data-type="image" tabindex="4"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119201825.png" alt="" loading="lazy"></figure>
<p>ExifInterface 能拿到的信息远远不止旋转角度，其他的参数感兴趣的童鞋可以看看 API 文档。</p>
<h3 id="拍完照怎么闪退了">拍完照怎么闪退了？</h3>
<p>曾在小米和魅族的某些机型上遇到过这样的问题，调用系统相机拍照，拍完点击确定回到自己的app里面却莫名奇妙的闪退了。这种闪退有两个特点：</p>
<ol>
<li>没有什么错误日志（有些机子啥日志都没有，有些机子会出来个空异常错误日志）；</li>
<li>同个机子上非必现（有时候怎么拍都不闪退，有时候一拍就闪退）；</li>
</ol>
<p>对待非必现问题往往比较头疼，当初遇到这样的问题也是非常不解。上网搜罗了一圈也没方案，后来留意到一个比较有意思信息：有些系统厂商的 ROM 会给自带相机应用做优化，当某个 app 通过 intent 进入相机拍照界面时，系统会把这个 app 当前最上层的 Activity 销毁回收。（注意：我遇到的情况是有时候很快就回收掉，有时候怎么等也不回收，没有什么必现规律）为了验证一下，便在启动相机的 Activity 中对 onDestory 方法进行加 log 。果不其然，终于发现进入拍照界面的时候 onDestory 方法被执行了。所以，前面提到的闪退基本可以推测是 Activity 被回收导致某些非UI控件的成员变量为空导致的。（有些机子会报出空异常错误日志，但是有些机子闪退了什么都不报，是不是觉得很奇葩！）</p>
<p>既然涉及到 Activity 被回收的问题，自然要想起 onSaveInstanceState 和 onRestoreInstanceState 这对方法。去到 onSaveInstanceState 把数据保存，并在 onRestoreInstanceState 方法中进行恢复即可。大体代码思路如下：</p>
<figure data-type="image" tabindex="5"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119201837.png" alt="" loading="lazy"></figure>
<p>对于  onSaveInstanceState 和 onRestoreInstanceState 方法的作用还不熟悉的童鞋，网上资料很多，可以自行搜索。</p>
<p>到这里，可能有童鞋要问，这种闪退并不能保证复现，我要怎么知道问题所在和是否修复了呢？我们可以去到开发者选项里开启不保留活动这一项进行调试验证</p>
<figure data-type="image" tabindex="6"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119201858.png" alt="" loading="lazy"></figure>
<p>它作用是保留当前和用户接触的 Activity ，并将目前无法和用户交互 Activity 进行销毁回收。打开这个调试选项就可以满足验证的需求，当你的 app 的某个 Activity 跳转到拍照的 Activity 后，这个 Activity 立马就会被系统销毁回收，这样就可以很好的完全复现闪退的场景，帮助开发者确认问题有没有修复了。</p>
<p>涉及到 Activity 被销毁，还想提一下代码实现上的问题。假设当前有两个 Activity ，MainActivity 中有个 Button ，点击可以调用系统相机拍照并显示到 PreviewActivity 进行预览。有下面两种实现方案：</p>
<ul>
<li>方案一：MainActivity 中点击 Button 后，启动系统相机拍照，并在 MainActivity 的 onActivityResult 方法中获取拍下来的照片，并启动跳转到 PreviewActivity 界面进行效果预览；</li>
<li>方案二：MainActivity 中点击 Button 后，启动 PreviewActivity 界面，在 PreviewActivity 的 onCreate（或者onStart、onResume）方法中启动系统相机拍照，然后在 PreviewActivity 的 onActivityResult 方法中获取拍下来的照片进行预览；</li>
</ul>
<p>上面两种方案得到的实现效果是一模一样的，但是第二种方案却存在很大的问题。因为启动相机的代码放在 onCreate（或者onStart、onResume）中，当进入拍照界面后，PreviewActivity 随即被销毁，拍完照确认后回到 PreviewActivity 时，被销毁的 PreviewActivity 需要重建，又要走一遍 onCreate、onStart、onResume，又调用了启动相机拍照的代码，周而复始的进入了死循环状态。为了避免让你的用户抓狂，果断明智的选择方案一。</p>
<p>以上这种情况提到调用系统拍照时，Activity就回收的情况，在小米4S和小米4 LTE机子上（MIUI的版本是7.3，Android系统版本是6.0）出现的概率很高。 所以，建议看到此文的童鞋也可以去验证适配一下。</p>
<h3 id="图片无法显示">图片无法显示</h3>
<p>图片无法显示这个问题也是略坑，如何坑法？往下看，同样是在小米4S和小米4 LTE机子上（MIUI的版本是7.3，Android系统版本是6.0）出现概率很高的场景（当然，不保证其他机子没出现过）。按照我们前面提到的业务场景，调用相机拍照完成后，我们的 app 会有一个预览图片的界面。但是在用了小米的机子进行拍照后，自己 app 的预览界面却怎么也无法显示出照片来，同样是相当郁闷，郁闷完后还是要一步一步去排查解决问题的！为此，需要一步一步猜测验证问题所在。</p>
<ul>
<li>猜测一：没有拿到照片路径，所以无法显示？<br>
直接断点打 log 跟踪，猜测一很快被推翻，路径是有的。</li>
<li>猜测二：Bitmap太大了，无法显示？<br>
直接在 AS 的 log 控制台仔细的观察了一下系统 log ，发现了一些蛛丝马迹</li>
</ul>
<figure data-type="image" tabindex="7"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119201920.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="8"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119201931.png" alt="" loading="lazy"></figure>
<p>每次拍完照片，都会出现上面这样的 log ，果然，因为图片太大而导致在 ImageView 上无法显示。到这里有童鞋要吐槽了，没对图片的采样率 inSampleSize 做处理？天地良心啊，绝对做处理了，直接看代码：</p>
<figure data-type="image" tabindex="9"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119201938.png" alt="" loading="lazy"></figure>
<p>瞄了代码后，是不是觉得没有问题了？没错，inSampleSize 确确实实经过处理，那为什么图片还是太大而显示不出来呢？ requestWidth、int requestHeight 设置得太大导致 inSampleSize 太小了？不可能啊，我都试着把长宽都设置成 100 了还是没法显示！干脆，直接打印 inSampleSize 值，一打印，inSampleSize 值居然为 1 。 我去，彻底打脸了，明明说好的处理过了，居然还是 1 ！！！！为了一探究竟，干脆加 log 。<br>
<img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119201949.png" alt="" loading="lazy"></p>
<p>运行打印出来的日志如下：</p>
<figure data-type="image" tabindex="10"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119202049.png" alt="" loading="lazy"></figure>
<p>图片原来的宽高居然都是 -1 ，真是奇葩了！难怪，inSampleSize 经过处理之后结果还是 1 。狠狠的吐槽了之后，总是要回来解决问题的。那么，图片的宽高信息都丢失了，我去哪里找啊？ 像下面这样？</p>
<figure data-type="image" tabindex="11"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119202037.png" alt="" loading="lazy"></figure>
<p>no，此方案行不通，inJustDecodeBounds = true 时，BitmapFactory 获得 Bitmap 对象是 null；那要怎样才能获图片的宽高呢？前面提到的 ExifInterface 再次帮了我们大忙，通过它的下面两个属性即可拿到图片真正的宽高</p>
<figure data-type="image" tabindex="12"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119202028.png" alt="" loading="lazy"></figure>
<p>顺手吐槽一下，为什么高不是 TAG_IMAGE_HEIGHT 而是 TAG_IMAGE_LENGTH。改良过后的代码实现如下：</p>
<figure data-type="image" tabindex="13"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119202018.png" alt="" loading="lazy"></figure>
<p>再看一下，打印出来的log<br>
<img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119202010.png" alt="" loading="lazy"></p>
<p>这样就可以解决问题啦。</p>
<h3 id="总结">总结</h3>
<p>以上总结了这么些身边童鞋经常问起，但网上又不多见的适配问题，希望可以帮到一些开发童鞋少走弯路。文中多次提到小米的机子，并不代表只有MIUI上有这样的问题存在，仅仅只是因为我身边带的几部机子大都是小米的。对待适配问题，在搜索引擎都无法提供多少有效的信息时，我们只能靠断点、打log、观察控制台的日志、以及API文档来寻找一些蛛丝马迹作为突破口，相信办法总比困难多。</p>
<p>以上的示例代码已经整理到：<a href="https://github.com/D-clock/AndroidStudyCode">https://github.com/D-clock/AndroidStudyCode </a></p>
</div>
                              <div class="mdui-divider mdui-m-t-3"></div>
                              <div class="mdui-row-xs-2 mdui-m-t-2">
  <div class="mdui-col"> <div class="mdui-text-left"><a href="https://fqzhanghao.github.io/post/shi-yong-android-studio-de-lint-qing-chu-wu-yong-de-zi-yuan-wen-jian">使用Android Studio的lint清除无用的资源文件</a></div></div>
 <div class="mdui-col"><div class="mdui-text-right "><a href="https://fqzhanghao.github.io/post/url-schemes">URL schemes</a></div> </div>
                                </div>
                                <div class="mdui-divider mdui-m-t-2"></div>
   
 <script src="https://fqzhanghao.github.io//media/scripts/Valine.min.js"></script>
 <div class="comment"></div>

<script>
      new Valine({
            el: '.comment',



            path: window.location.pathname,
            pageSize: 30,
            avatar:'mm', 
       })

    </script> 
<script>
    if(window.location.hash){
        var checkExist = setInterval(function() {
           if ($(window.location.hash).length) {
              $('html, body').animate({scrollTop: $(window.location.hash).offset().top-90}, 1000);
              clearInterval(checkExist);
           }
        }, 100);
    }
</script>
                         </article>
                 <div class="toc-container mdui-float-right">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li>
<ul>
<li><a href="#%E6%8B%8D%E7%85%A7%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0">拍照功能实现</a></li>
<li><a href="#%E6%9C%89%E6%B2%A1%E6%9C%89%E7%9B%B8%E6%9C%BA%E5%8F%AF%E7%94%A8">有没有相机可用？</a></li>
<li><a href="#%E6%8B%8D%E5%87%BA%E6%9D%A5%E7%9A%84%E7%85%A7%E7%89%87%E6%AD%AA%E4%BA%86">拍出来的照片“歪了”！！！</a></li>
<li><a href="#%E6%8B%8D%E5%AE%8C%E7%85%A7%E6%80%8E%E4%B9%88%E9%97%AA%E9%80%80%E4%BA%86">拍完照怎么闪退了？</a></li>
<li><a href="#%E5%9B%BE%E7%89%87%E6%97%A0%E6%B3%95%E6%98%BE%E7%A4%BA">图片无法显示</a></li>
<li><a href="#%E6%80%BB%E7%BB%93">总结</a></li>
</ul>
</li>
</ul>
</li>
</ul>

              </div>

                        </div>
                 </div>
          
        </div>
        <script data-no-instant>
    (function ($) {
        $.extend({
            adamsOverload: function () {
                $.viewImage({
                    'target'  : '.post-neirong img',
                    'exclude' : '.vsmile-icons img , .song-links-item img',
                    'delay'   : 300
                });
            }
        });
    })(jQuery);
    jQuery.adamsOverload();
</script>
        <footer class="footer mdui-m-t-5 mdui-text-center">
               <nav class="social-links">
                      <ul>
                      
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                      </ul>
                    </nav>
                  <div class="copyright">
                      <p>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a></p>
                  </div>
              </footer>
    </body>
</html>