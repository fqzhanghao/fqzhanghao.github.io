<html>
      <head>
        <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1,user-scalable=no" />
        <meta charset="utf-8">
        <meta name="referrer" content="never">
        <title>Android扫描多媒体文件剖析 | 浩浩的博客</title>
        <link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.11.1/katex.min.css">
        <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://fqzhanghao.github.io//styles/main.css">
          <script src="https://fqzhanghao.github.io//media/scripts/mdui.min.js"></script>
        <link rel="stylesheet" href="https://at.alicdn.com/t/font_1306644_jwtuc2zzbrd.css">
        <link href="https://fonts.googleapis.com/css?family=Dancing+Script|Ma+Shan+Zheng&display=swap" rel="stylesheet">
        <script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
        <script src="https://fqzhanghao.github.io//media/scripts/script.js"></script>
        <script >hljs.initHighlightingOnLoad();</script>
        

    </head>
    <body class="mdui-theme-primary-purple mdui-theme-accent-purple">
        <header class="index-img mdui-m-b-3" >
                          <button class="mdui-btn  mdui-btn-icon mdui-btn-dense mdui-color-theme-500 mdui-ripple yinying mdui-m-t-1 mdui-m-l-1" mdui-menu="{target: '#demo-attr-cascade'}"><i class="mdui-icon material-icons">&#xe5d2;</i></button>
                <ul class="mdui-menu" id="demo-attr-cascade">
                
                        <li class="mdui-menu-item">
                          <a href="/" class="mdui-ripple">首页</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/archives" class="mdui-ripple">归档</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/post/about" class="mdui-ripple">关于</a>
                        </li>
                
                      </ul>

        </header>
        <div class="mdui-container post">
                <div class="mdui-row">
                        <div class="mdui-col-md-8 mdui-col-offset-md-2 ">
                         <article class="mdui-shadow-10 mdui-p-a-2 post-list">
                           <div class="mdui-typo-display-1 mdui-m-b-3">Android扫描多媒体文件剖析</div>
                           <a  class="index-list-biaoqian ">2020-01-19</a>
                           <div class="mdui-typo mdui-m-t-3 post-neirong"><p>这篇文章从系统源代码分析，讲述如何将程序创建的多媒体文件加入系统的媒体库，如何从媒体库删除，以及大多数程序开发者经常遇到的无法添加到媒体库的问题等。本人将通过对源代码的分析，一一解释这些问题。</p>
<!--more-->
<h3 id="android中的多媒体文件扫描机制">Android中的多媒体文件扫描机制</h3>
<p>Android提供了一个很棒的程序来处理将多媒体文件加入的媒体库中。这个程序就是MediaProvider，现在我们简单看以下这个程序。首先看一下它的Receiver</p>
<pre><code class="language-xml">&lt;receiver android:name=&quot;MediaScannerReceiver&quot;&gt;
        &lt;intent-filter&gt;
            &lt;action android:name=&quot;android.intent.action.BOOT_COMPLETED&quot; /&gt;
        &lt;/intent-filter&gt;
        &lt;intent-filter&gt;
            &lt;action android:name=&quot;android.intent.action.MEDIA_MOUNTED&quot; /&gt;
            &lt;data android:scheme=&quot;file&quot; /&gt;
        &lt;/intent-filter&gt;
        &lt;intent-filter&gt;
            &lt;action android:name=&quot;android.intent.action.MEDIA_UNMOUNTED&quot; /&gt;
            &lt;data android:scheme=&quot;file&quot; /&gt;
        &lt;/intent-filter&gt;
        &lt;intent-filter&gt;
            &lt;action android:name=&quot;android.intent.action.MEDIA_SCANNER_SCAN_FILE&quot; /&gt;
            &lt;data android:scheme=&quot;file&quot; /&gt;
        &lt;/intent-filter&gt;
    &lt;/receiver&gt;
</code></pre>
<p>MediaScannerReceiver只接收符合action和数据规则正确的intent。</p>
<h3 id="mediascannerreciever如何处理intent">MediaScannerReciever如何处理Intent</h3>
<ul>
<li>当且仅当接收到action android.intent.action.BOOT_COMPLETED才扫描内部存储（非内置和外置sdcard）</li>
<li>除了action为android.intent.action.BOOT_COMPLETED 的以外的intent都必须要有数据传递。</li>
<li>当收到 Intent.ACTION_MEDIA_MOUNTED intent，扫描Sdcard</li>
<li>当收到 Intent.ACTION_MEDIA_SCANNER_SCAN_FILE intent，检测没有问题，将扫描单个文件。</li>
</ul>
<h3 id="mediascannerservice如何工作">MediaScannerService如何工作</h3>
<p>实际上MediaScannerReceiver并不是真正处理扫描工作，它会启动一个叫做MediaScannerService的服务。我们继续看MediaProvider的manifest中关于service的部分。</p>
<pre><code class="language-xml">  &lt;service android:name=&quot;MediaScannerService&quot; android:exported=&quot;true&quot;&gt;
        &lt;intent-filter&gt;
            &lt;action android:name=&quot;android.media.IMediaScannerService&quot; /&gt;
        &lt;/intent-filter&gt;
    &lt;/service&gt;
</code></pre>
<p>MediaScannerService中的scanFile方法</p>
<pre><code class="language-java">private Uri scanFile(String path, String mimeType) {
    String volumeName = MediaProvider.EXTERNAL_VOLUME;
    openDatabase(volumeName);
    MediaScanner scanner = createMediaScanner();
    return scanner.scanSingleFile(path, volumeName, mimeType);
}
</code></pre>
<p>MediaScannerService中的scan方法</p>
<pre><code class="language-java">private void scan(String[] directories, String volumeName) {
    // don't sleep while scanning
    mWakeLock.acquire();

    ContentValues values = new ContentValues();
    values.put(MediaStore.MEDIA_SCANNER_VOLUME, volumeName);
    Uri scanUri = getContentResolver().insert(MediaStore.getMediaScannerUri(), values);

    Uri uri = Uri.parse(&quot;file://&quot; + directories[0]);
    sendBroadcast(new Intent(Intent.ACTION_MEDIA_SCANNER_STARTED, uri));

    try {
        if (volumeName.equals(MediaProvider.EXTERNAL_VOLUME)) {
            openDatabase(volumeName);
        }

        MediaScanner scanner = createMediaScanner();
        scanner.scanDirectories(directories, volumeName);
    } catch (Exception e) {
        Log.e(TAG, &quot;exception in MediaScanner.scan()&quot;, e);
    }

    getContentResolver().delete(scanUri, null, null);

    sendBroadcast(new Intent(Intent.ACTION_MEDIA_SCANNER_FINISHED, uri));
    mWakeLock.release();
}
</code></pre>
<p>MediaScannerService中的createMediaScanner方法</p>
<pre><code class="language-java">private MediaScanner createMediaScanner() {
        MediaScanner scanner = new MediaScanner(this);
        Locale locale = getResources().getConfiguration().locale;
        if (locale != null) {
            String language = locale.getLanguage();
            String country = locale.getCountry();
            String localeString = null;
            if (language != null) {
                if (country != null) {
                    scanner.setLocale(language + &quot;_&quot; + country);
                } else {
                    scanner.setLocale(language);
                }
            }
        }

        return scanner;
}
</code></pre>
<p>从上面可以发现，真正工作的其实是android.media.MediaScanner.java 具体扫描过程就请点击链接查看。<a href="https://android.googlesource.com/platform/frameworks/base/+/cd92588/media/java/android/media/MediaScanner.java">https://android.googlesource.com/platform/frameworks/base/+/cd92588/media/java/android/media/MediaScanner.java</a></p>
<h3 id="如何扫描一个刚创建的文件">如何扫描一个刚创建的文件</h3>
<p>这里介绍两种方式来实现将新创建的文件加入媒体库。</p>
<ul>
<li><strong>最简单的方式</strong></li>
</ul>
<p>只需要发送一个正确的intent广播到MediaScannerReceiver即可。</p>
<pre><code class="language-java">String saveAs = &quot;Your_Created_File_Path&quot;
Uri contentUri = Uri.fromFile(new File(saveAs));
Intent mediaScanIntent = new Intent(Intent.ACTION_MEDIA_SCANNER_SCAN_FILE,contentUri);
getContext().sendBroadcast(mediaScanIntent);

</code></pre>
<p>上面的极简方法大多数情况下正常工作，但是有些情况下是不会工作的，稍后的部分会介绍。即使你使用上述方法成功了，还是建议你继续阅读稍后的为什么发广播不成功的部分。</p>
<ul>
<li><strong>使用MediaScannerConnection</strong></li>
</ul>
<pre><code class="language-java">public void mediaScan(File file) {
    MediaScannerConnection.scanFile(getActivity(),
            new String[] { file.getAbsolutePath() }, null,
            new OnScanCompletedListener() {
                @Override
                public void onScanCompleted(String path, Uri uri) {
                    Log.v(&quot;MediaScanWork&quot;, &quot;file &quot; + path
                            + &quot; was scanned seccessfully: &quot; + uri);
                }
            });
}
</code></pre>
<p>MediaScannerConnection的scanFile方法从2.2（API 8）开始引入。</p>
<p>创建一个MediaScannerConnection对象然后调用scanFile方法</p>
<p>很简单，参考<a href="http://developer.android.com/reference/android/media/MediaScannerConnection.html">http://developer.android.com/reference/android/media/MediaScannerConnection.html</a></p>
<h3 id="如何扫描多个文件">如何扫描多个文件</h3>
<ul>
<li>发送多个Intent.ACTION_MEDIA_SCANNER_SCAN_FILE广播</li>
<li>使用MediaScannerConnection，传入要加入的路径的数组。</li>
</ul>
<h3 id="为什么发送media_scanner_scan_file广播不生效">为什么发送MEDIA_SCANNER_SCAN_FILE广播不生效</h3>
<p>关于为什么有些设备上不生效，很多人认为是API原因，其实不是的，这其实和你传入的文件路径有关系。看一下接收者Receiver的onReceive代码。</p>
<pre><code class="language-java">public void onReceive(Context context, Intent intent) {
    String action = intent.getAction();
    Uri uri = intent.getData();
    if (action.equals(Intent.ACTION_BOOT_COMPLETED)) {
        // scan internal storage
        scan(context, MediaProvider.INTERNAL_VOLUME);
    } else {
        if (uri.getScheme().equals(&quot;file&quot;)) {
            // handle intents related to external storage
            String path = uri.getPath();
            String externalStoragePath = Environment.getExternalStorageDirectory().getPath();

            Log.d(TAG, &quot;action: &quot; + action + &quot; path: &quot; + path);
            if (action.equals(Intent.ACTION_MEDIA_MOUNTED)) {
                // scan whenever any volume is mounted
                scan(context, MediaProvider.EXTERNAL_VOLUME);
            } else if (action.equals(Intent.ACTION_MEDIA_SCANNER_SCAN_FILE) &amp;&amp;
                    path != null &amp;&amp; path.startsWith(externalStoragePath + &quot;/&quot;)) {
                scanFile(context, path);
            }
        }
    }
}
</code></pre>
<p>所有的部分都正确除了传入的路径。因为你可能硬编码了文件路径。因为有一个这样的判断path.startsWith(externalStoragePath + &quot;/&quot;),这里我举一个简单的小例子。</p>
<pre><code class="language-java">final String saveAs = &quot;/sdcard/&quot; + System.currentTimeMillis() + &quot;_add.png&quot;;
Uri contentUri = Uri.fromFile(new File(saveAs));
Intent mediaScanIntent = new Intent(Intent.ACTION_MEDIA_SCANNER_SCAN_FILE,contentUri);
getContext().sendBroadcast(mediaScanIntent);
Uri uri = mediaScanIntent.getData();
String path = uri.getPath();
String externalStoragePath = Environment.getExternalStorageDirectory().getPath();
Log.i(&quot;LOGTAG&quot;, &quot;Androidyue onReceive intent= &quot; + mediaScanIntent
                        + &quot;;path=&quot; + path + &quot;;externalStoragePath=&quot; +
                        externalStoragePath);
</code></pre>
<p>我们看一下输出日志，分析原因。</p>
<pre><code class="language-java">LOGTAG Androidyue onReceive intent= Intent { act=android.intent.action.MEDIA_SCANNER_SCAN_FILE dat=file:///sdcard/1390136305831_add.png };path=/sdcard/1390136305831_add.png;externalStoragePath=/mnt/sdcard
</code></pre>
<p>上述输出分析，你发送的广播，action是正确的，数据规则也是正确的，而且你的文件路径也是存在的，但是，文件的路径/sdcard/1390136305831_add.png并不是以外部存储根路径/mnt/sdcard/开头。所以扫描操作没有开始，导致文件没有加入到媒体库。所以，请检查文件的路径。</p>
<h3 id="如何从多媒体库中移除">如何从多媒体库中移除</h3>
<p>如果我们删除一个多媒体文件的话，也就意味我们还需要将这个文件从媒体库中删除掉。</p>
<p>能不能简简单单发广播？</p>
<p>仅仅发一个广播能解决问题么？我倒是希望可以，但是实际上是不工作的，查看如下代码即可明白。</p>
<pre><code class="language-java">// this function is used to scan a single file
public Uri scanSingleFile(String path, String volumeName, String mimeType) {
    try {
        initialize(volumeName);
        prescan(path, true);

        File file = new File(path);
        if (!file.exists()) {
            return null;
        }

        // lastModified is in milliseconds on Files.
        long lastModifiedSeconds = file.lastModified() / 1000;

        // always scan the file, so we can return the content://media Uri for existing files
        return mClient.doScanFile(path, mimeType, lastModifiedSeconds, file.length(),
                false, true, MediaScanner.isNoMediaPath(path));
    } catch (RemoteException e) {
        Log.e(TAG, &quot;RemoteException in MediaScanner.scanFile()&quot;, e);
        return null;
    }
}
</code></pre>
<p>正如上述代码，会对文件是否存在进行检查，如果文件不存在，直接停止向下执行。所以这样是不行的。那怎么办呢？</p>
<pre><code class="language-java">public void testDeleteFile() {
    String existingFilePath = &quot;/mnt/sdcard/1390116362913_add.png&quot;;
    File  existingFile = new File(existingFilePath);
    existingFile.delete();
    ContentResolver resolver = getActivity().getContentResolver();
    resolver.delete(Images.Media.EXTERNAL_CONTENT_URI, Images.Media.DATA + &quot;=?&quot;, new String[]{existingFilePath});

}
</code></pre>
<p>上述代码是可以工作的，直接从MediaProvider删除即可。 具体的删除代码请参考<a href="http://droidyue.com/blog/2014/02/09/code-snippet-for-media-on-android/" title="Code Snippet for Media on Android">http://droidyue.com/blog/2014/02/09/code-snippet-for-media-on-android/</a></p>
</div>
                              <div class="mdui-divider mdui-m-t-3"></div>
                              <div class="mdui-row-xs-2 mdui-m-t-2">
  <div class="mdui-col"> <div class="mdui-text-left"><a href="https://fqzhanghao.github.io/post/android-huan-fu-gong-neng-zhong-ru-he-dong-tai-huo-qu-kong-jian-zhong-bei-jing-tu-pian-de-zi-yuan-id">android换肤功能中，如何动态获取控件中背景图片的资源id？</a></div></div>
 <div class="mdui-col"><div class="mdui-text-right "><a href="https://fqzhanghao.github.io/post/android-kai-fa-chang-jian-de-activity-zhong-nei-cun-xie-lou-ji-jie-jue-ban-fa">Android开发常见的Activity中内存泄漏及解决办法</a></div> </div>
                                </div>
                                <div class="mdui-divider mdui-m-t-2"></div>
   
 <script src="https://fqzhanghao.github.io//media/scripts/Valine.min.js"></script>
 <div class="comment"></div>

<script>
      new Valine({
            el: '.comment',



            path: window.location.pathname,
            pageSize: 30,
            avatar:'mm', 
       })

    </script> 
<script>
    if(window.location.hash){
        var checkExist = setInterval(function() {
           if ($(window.location.hash).length) {
              $('html, body').animate({scrollTop: $(window.location.hash).offset().top-90}, 1000);
              clearInterval(checkExist);
           }
        }, 100);
    }
</script>
                         </article>
                 <div class="toc-container mdui-float-right">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li>
<ul>
<li><a href="#android%E4%B8%AD%E7%9A%84%E5%A4%9A%E5%AA%92%E4%BD%93%E6%96%87%E4%BB%B6%E6%89%AB%E6%8F%8F%E6%9C%BA%E5%88%B6">Android中的多媒体文件扫描机制</a></li>
<li><a href="#mediascannerreciever%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86intent">MediaScannerReciever如何处理Intent</a></li>
<li><a href="#mediascannerservice%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C">MediaScannerService如何工作</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E6%89%AB%E6%8F%8F%E4%B8%80%E4%B8%AA%E5%88%9A%E5%88%9B%E5%BB%BA%E7%9A%84%E6%96%87%E4%BB%B6">如何扫描一个刚创建的文件</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E6%89%AB%E6%8F%8F%E5%A4%9A%E4%B8%AA%E6%96%87%E4%BB%B6">如何扫描多个文件</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%91%E9%80%81media_scanner_scan_file%E5%B9%BF%E6%92%AD%E4%B8%8D%E7%94%9F%E6%95%88">为什么发送MEDIA_SCANNER_SCAN_FILE广播不生效</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E4%BB%8E%E5%A4%9A%E5%AA%92%E4%BD%93%E5%BA%93%E4%B8%AD%E7%A7%BB%E9%99%A4">如何从多媒体库中移除</a></li>
</ul>
</li>
</ul>
</li>
</ul>

              </div>

                        </div>
                 </div>
          
        </div>
        <script data-no-instant>
    (function ($) {
        $.extend({
            adamsOverload: function () {
                $.viewImage({
                    'target'  : '.post-neirong img',
                    'exclude' : '.vsmile-icons img , .song-links-item img',
                    'delay'   : 300
                });
            }
        });
    })(jQuery);
    jQuery.adamsOverload();
</script>
        <footer class="footer mdui-m-t-5 mdui-text-center">
               <nav class="social-links">
                      <ul>
                      
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                      </ul>
                    </nav>
                  <div class="copyright">
                      <p>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a></p>
                  </div>
              </footer>
    </body>
</html>