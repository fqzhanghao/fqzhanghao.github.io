<html>
      <head>
        <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1,user-scalable=no" />
        <meta charset="utf-8">
        <meta name="referrer" content="never">
        <title>Android 5.0之后隐式声明Intent 启动Service引发的问题 | 浩浩的博客</title>
        <link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.11.1/katex.min.css">
        <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://fqzhanghao.github.io//styles/main.css">
          <script src="https://fqzhanghao.github.io//media/scripts/mdui.min.js"></script>
        <link rel="stylesheet" href="https://at.alicdn.com/t/font_1306644_jwtuc2zzbrd.css">
        <link href="https://fonts.googleapis.com/css?family=Dancing+Script|Ma+Shan+Zheng&display=swap" rel="stylesheet">
        <script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
        <script src="https://fqzhanghao.github.io//media/scripts/script.js"></script>
        <script >hljs.initHighlightingOnLoad();</script>
        

    </head>
    <body class="mdui-theme-primary-purple mdui-theme-accent-purple">
        <header class="index-img mdui-m-b-3" >
                          <button class="mdui-btn  mdui-btn-icon mdui-btn-dense mdui-color-theme-500 mdui-ripple yinying mdui-m-t-1 mdui-m-l-1" mdui-menu="{target: '#demo-attr-cascade'}"><i class="mdui-icon material-icons">&#xe5d2;</i></button>
                <ul class="mdui-menu" id="demo-attr-cascade">
                
                        <li class="mdui-menu-item">
                          <a href="/" class="mdui-ripple">首页</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/archives" class="mdui-ripple">归档</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/post/about" class="mdui-ripple">关于</a>
                        </li>
                
                      </ul>

        </header>
        <div class="mdui-container post">
                <div class="mdui-row">
                        <div class="mdui-col-md-8 mdui-col-offset-md-2 ">
                         <article class="mdui-shadow-10 mdui-p-a-2 post-list">
                           <div class="mdui-typo-display-1 mdui-m-b-3">Android 5.0之后隐式声明Intent 启动Service引发的问题</div>
                           <a  class="index-list-biaoqian ">2020-01-19</a>
                           <div class="mdui-typo mdui-m-t-3 post-neirong"><h3 id="一概述">一.概述</h3>
<p>Android系统升级到5.0之后做了不少的变化(5.0变化),开发人员一定要注意这些变化,要不然就有的折腾了.这次最大的变化应该是把Dalvik虚拟机改成了ART(Android Runtime),后续会专门讲解这一块.其他的都是一些零碎的问题,例如前段时间发了一篇Android 5.0之后修改了HashMap的实现(传送门).这篇主要讲一下遇到跟Service相关的问题.</p>
<!--more-->
<h3 id="二详情">二.详情</h3>
<p>Service身为Android四大组件之一,它的使用频率还是比较高的,并且现在主要都是运用在比较关键的部位,例如升级推送等.在Android 5.0之后google出于安全的角度禁止了隐式声明Intent来启动Service.也禁止使用Intent filter.否则就会抛个异常出来.</p>
<figure data-type="image" tabindex="1"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119190715.png" alt="" loading="lazy"></figure>
<p>官方的解释如下.</p>
<figure data-type="image" tabindex="2"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119190750.png" alt="" loading="lazy"></figure>
<p>那么google到底是怎么限制的呢?限制的判定条件是什么呢？这些都可以从Android 4.4和Android 5.0的源码中找到区别.</p>
<p>在Android 4.4的ContextImpl源码中,能看到如果启动service的intent的component和package都为空并且版本大于KITKAT的时候只是报出一个警报,告诉开发者隐式声明intent去启动Service是不安全的.再往下看,丫的异常都写好了只是注释掉了,看来google早就想这么干了.</p>
<pre><code class="language-java">private void validateServiceIntent(Intent service) {  
    if (service.getComponent() == null &amp;&amp; service.getPackage() == null) {  
        if (true || getApplicationInfo().targetSdkVersion &gt;= Build.VERSION_CODES.KITKAT) {  
            Log.w(TAG, &quot;Implicit intents with startService are not safe: &quot; + service  
                    + &quot; &quot; + Debug.getCallers(2, 3));  
            //IllegalArgumentException ex = new IllegalArgumentException(  
            //        &quot;Service Intent must be explicit: &quot; + service);  
            //Log.e(TAG, &quot;This will become an error&quot;, ex);  
            //throw ex;  
        }  
    }  
} 
</code></pre>
<p>果然在Android 5.0的源码中上面注释的代码已经不注释了,当targetSdkVersion版本大于LOLLIPOP直接异常抛出来,要求Service intent必须显式声明.所以如果开发的应用指定targetSdkVersion版本是小于LOLLIPOP的话还是按以前的方式给报个警报,这也就造成了如果没有做了完善的Android 5.0兼容就贸然把targetSdkVersion升到LOLLIPOP的话很有可能就会碰到这个问题.并且这个问题是很严重的,想象一下,你的app自升级的Service是隐式启动的,碰到这个问题后app就不能自升级了,这批用户有可能就一直停留在当前版本.会产生很致命的问题.</p>
<pre><code class="language-java">private void validateServiceIntent(Intent service) {  
    if (service.getComponent() == null &amp;&amp; service.getPackage() == null) {  
        if (getApplicationInfo().targetSdkVersion &gt;= Build.VERSION_CODES.LOLLIPOP) {  
            IllegalArgumentException ex = new IllegalArgumentException(  
                    &quot;Service Intent must be explicit: &quot; + service);  
            throw ex;  
        } else {  
            Log.w(TAG, &quot;Implicit intents with startService are not safe: &quot; + service  
                    + &quot; &quot; + Debug.getCallers(2, 3));  
        }  
    }  
}
</code></pre>
<p>从源码中的逻辑来看的话,判断一个intent是不是显式声明的点就是component和package,只要这两个有一个生效就不算是隐式声明的,接下来继续分析一下Intent的源码,可以看到下面三种构造方式,设置action来声明Intent是没有构建component的,所以显式声明需要用到第一和第二种构造(还有带packagename或component的拷贝构造),或者后面设置package属性.</p>
<pre><code class="language-java">public Intent(Context packageContext, Class&lt;?&gt; cls) {  
    mComponent = new ComponentName(packageContext, cls);  
}  
public Intent(String action) {  
    setAction(action);  
}  
public Intent(String action, Uri uri,  
              Context packageContext, Class&lt;?&gt; cls) {  
    setAction(action);  
    mData = uri;  
    mComponent = new ComponentName(packageContext, cls);  
}  
public Intent setPackage(String packageName) {  
    if (packageName != null &amp;&amp; mSelector != null) {  
        throw new IllegalArgumentException(  
                &quot;Can't set package name when selector is already set&quot;);  
    }  
    mPackage = packageName;  
    return this;  
}  
</code></pre>
<h3 id="三案例分析">三.案例分析</h3>
<p>经过这么分析之后单看这个问题是很好做兼容的,但是结合实际的一些复杂情况就不一定了.之前就碰到过一个比较复杂的兼容.</p>
<p>场景复现:</p>
<p>将项目里的targetSdkVersion升级到22之后,针对这篇Service的问题做了兼容,so easy啊,但是万万没想到项目里用的某盟的第三方登陆分享的SDK版本太老了(一年前),开发没有去升级SDK跟check兼容性.并且经过四轮测试愣是没有测到这个点,结果在线上发现了这个Bug,泥煤啊Android 5.0设备用微博登陆就闪退,泥煤啊.幸好这个项目做了线上bug热修复,这个时候就体现出这个功能的好处了,之前又博客简单讲解了一下实现原理(传送门).</p>
<p>接下来思路就是升级最新的某盟SDK然后打个补丁包给线上升级过去.然而升级完最新的SDK之后发现并没有什么卵用,看过热修复那篇博客的童鞋应该可以想到,那种打dex补丁的形式是不能添加新资源的,而最新的SDK新增了不少资源进来,所以这个思路是行不通的.<br>
既然升级最新的SDK不行,那能不能修改老的SDK自己给它做Android 5.0兼容呢?理论上来说是可行的.说干就干,先记录一下SDK崩溃的记录.</p>
<figure data-type="image" tabindex="3"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119190807.png" alt="" loading="lazy"></figure>
<p>再把SDK jar反编译一下,里面很多被混淆过,幸好崩溃的位置这个类的逻辑还有可读性都还比较完整.直接定位到崩溃的方法.果然是隐式绑定的Service,上面分析源码的时候从Intent构造源码可以看到这种声明方式既没有构造有效的component,也没有提供出packageName,崩了也无话可说.</p>
<figure data-type="image" tabindex="4"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119190825.png" alt="" loading="lazy"></figure>
<p>既然定位到了位置,那么就单独把这个类抽离出来,新开一个Android工程,建立一个library的module,里面只有接下来要修改的这一个文件,由于这个类里面会引用SDK jar包里面的资源,所以也要把jar包引入到module里面.</p>
<figure data-type="image" tabindex="5"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119190838.png" alt="" loading="lazy"></figure>
<p>包名一定要和之前一模一样.因为我们修改过之后要替换掉SDK中原有的.class文件.</p>
<figure data-type="image" tabindex="6"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119190849.png" alt="" loading="lazy"></figure>
<p>build一下每问题,OK.因为这里启动的Service是新浪微博客户端里面的一个Service,连接上之后会通过AIDL进行跨进程通讯.所以我们没办法在构造Intent的时候就显式声明.既然没有办法构建有效的component,那么给它设置一个包名也可以生效的.既然是新浪微博那么包名应该是com.sina.weibo.</p>
<pre><code class="language-java">private boolean a(Activity paramActivity)  
{  
    Context localContext = paramActivity.getApplicationContext();  
    Intent mIntent = new Intent(&quot;com.sina.weibo.remotessoservice&quot;);  
    mIntent.setPackage(&quot;com.sina.weibo&quot;);  
    return localContext.bindService(mIntent, this.serviceConnection, Context.BIND_AUTO_CREATE);  
}  
</code></pre>
<p>reBuild一下,然后去主项目build文件夹里面的中间资源里面找到module打成的jar包,直接把编译好的.class解压出来.</p>
<figure data-type="image" tabindex="7"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119190901.png" alt="" loading="lazy"></figure>
<p>解压某盟的SDK,进入到正确的路径下直接替换刚才编译出来的.class文件.</p>
<figure data-type="image" tabindex="8"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119190914.png" alt="" loading="lazy"></figure>
<p>回到SDK的跟目录下,运行 jar cvf sdk.jar * 命令进行重打包,将重新打好的SDK替换到项目里面.验证bug.BinGo!搞定!这样就可以打个dex补丁包给线上的版本更新过去修复5.0兼容的bug了.</p>
<h3 id="四总结">四.总结</h3>
<p>这里结合这个案例简单分析了一下Android 5.0之后对启动绑定Service做的变化.碰到这种问题也是因为做兼容的时候没有覆盖所有的地方,这些坑都是跑不掉的.</p>
</div>
                              <div class="mdui-divider mdui-m-t-3"></div>
                              <div class="mdui-row-xs-2 mdui-m-t-2">
  <div class="mdui-col"> <div class="mdui-text-left"><a href="https://fqzhanghao.github.io/post/android-build-ji-xiang-guan-lei">Android Build及相关类</a></div></div>
 <div class="mdui-col"><div class="mdui-text-right "><a href="https://fqzhanghao.github.io/post/android-shi-jian-chu-li-ji-zhi-zhi-requestdisallowintercepttouchevent">android 事件处理机制之requestDisallowInterceptTouchEvent</a></div> </div>
                                </div>
                                <div class="mdui-divider mdui-m-t-2"></div>
   
 <script src="https://fqzhanghao.github.io//media/scripts/Valine.min.js"></script>
 <div class="comment"></div>

<script>
      new Valine({
            el: '.comment',



            path: window.location.pathname,
            pageSize: 30,
            avatar:'mm', 
       })

    </script> 
<script>
    if(window.location.hash){
        var checkExist = setInterval(function() {
           if ($(window.location.hash).length) {
              $('html, body').animate({scrollTop: $(window.location.hash).offset().top-90}, 1000);
              clearInterval(checkExist);
           }
        }, 100);
    }
</script>
                         </article>
                 <div class="toc-container mdui-float-right">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li>
<ul>
<li><a href="#%E4%B8%80%E6%A6%82%E8%BF%B0">一.概述</a></li>
<li><a href="#%E4%BA%8C%E8%AF%A6%E6%83%85">二.详情</a></li>
<li><a href="#%E4%B8%89%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90">三.案例分析</a></li>
<li><a href="#%E5%9B%9B%E6%80%BB%E7%BB%93">四.总结</a></li>
</ul>
</li>
</ul>
</li>
</ul>

              </div>

                        </div>
                 </div>
          
        </div>
        <script data-no-instant>
    (function ($) {
        $.extend({
            adamsOverload: function () {
                $.viewImage({
                    'target'  : '.post-neirong img',
                    'exclude' : '.vsmile-icons img , .song-links-item img',
                    'delay'   : 300
                });
            }
        });
    })(jQuery);
    jQuery.adamsOverload();
</script>
        <footer class="footer mdui-m-t-5 mdui-text-center">
               <nav class="social-links">
                      <ul>
                      
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                      </ul>
                    </nav>
                  <div class="copyright">
                      <p>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a></p>
                  </div>
              </footer>
    </body>
</html>