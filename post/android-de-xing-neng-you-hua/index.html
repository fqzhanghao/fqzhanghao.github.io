<html>
      <head>
        <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1,user-scalable=no" />
        <meta charset="utf-8">
        <meta name="referrer" content="never">
        <title>Android的性能优化 | 浩浩的博客</title>
        <link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.11.1/katex.min.css">
        <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://fqzhanghao.github.io//styles/main.css">
          <script src="https://fqzhanghao.github.io//media/scripts/mdui.min.js"></script>
        <link rel="stylesheet" href="https://at.alicdn.com/t/font_1306644_jwtuc2zzbrd.css">
        <link href="https://fonts.googleapis.com/css?family=Dancing+Script|Ma+Shan+Zheng&display=swap" rel="stylesheet">
        <script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
        <script src="https://fqzhanghao.github.io//media/scripts/script.js"></script>
        <script >hljs.initHighlightingOnLoad();</script>
        

    </head>
    <body class="mdui-theme-primary-purple mdui-theme-accent-purple">
        <header class="index-img mdui-m-b-3" >
                          <button class="mdui-btn  mdui-btn-icon mdui-btn-dense mdui-color-theme-500 mdui-ripple yinying mdui-m-t-1 mdui-m-l-1" mdui-menu="{target: '#demo-attr-cascade'}"><i class="mdui-icon material-icons">&#xe5d2;</i></button>
                <ul class="mdui-menu" id="demo-attr-cascade">
                
                        <li class="mdui-menu-item">
                          <a href="/" class="mdui-ripple">首页</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/archives" class="mdui-ripple">归档</a>
                        </li>
                
                        <li class="mdui-menu-item">
                          <a href="/post/about" class="mdui-ripple">关于</a>
                        </li>
                
                      </ul>

        </header>
        <div class="mdui-container post">
                <div class="mdui-row">
                        <div class="mdui-col-md-8 mdui-col-offset-md-2 ">
                         <article class="mdui-shadow-10 mdui-p-a-2 post-list">
                           <div class="mdui-typo-display-1 mdui-m-b-3">Android的性能优化</div>
                           <a  class="index-list-biaoqian ">2020-01-19</a>
                           <div class="mdui-typo mdui-m-t-3 post-neirong"><p>转自:<a href="http://blog.csdn.net/MeloDev/article/details/51038694">http://blog.csdn.net/MeloDev/article/details/51038694</a></p>
<!--more-->
<h3 id="零性能指标">零：性能指标</h3>
<ol>
<li>布局复杂度：布局复杂会导致布局需要更长的时间，从而导致进入应用慢、页面切换慢；</li>
<li>耗电量：耗电量大会导致机器发热、缩短机器的有效使用时长；</li>
<li>内存：内存消耗大会导致频繁GC，GC时会暂停其它工作，导致页面卡顿；内存泄露会导致剩余可用内存越来越小；内存不足会导致应用异常；</li>
<li>网络：频繁的网络访问会导致耗电和影响应用的性能；网络交互数据大小会影响网络传输的效率；</li>
<li>程序执行效率：糟糕的代码会严重影响程序的运行效率，UI线程过多的任务会阻塞应用的正常运行，长时间持有某个对象会导致潜在的内存泄露，频繁的IO操作、网络操作而不用缓存会严重影响程序的运行效率。</li>
</ol>
<h3 id="一布局复杂度的优化">一：布局复杂度的优化</h3>
<p>关于布局的优化，主要分两个大方向</p>
<p><strong>1. 实现相同界面效果并且层级结构相同时，选用何种Layout最好</strong><br>
在Android中单独的布局性能：FrameLayout&gt;LinearLayout&gt;RelativeLayout</p>
<p>可供参考的网址：<a href="http://www.jianshu.com/p/8a7d059da746">LinearLayout与RelativeLayout的性能比较</a></p>
<p>总结:</p>
<ol>
<li>RelativeLayout会让子View调用2次onMeasure，LinearLayout 在有weight时，也会调用子View2次onMeasure;</li>
<li>RelativeLayout的子View如果高度和RelativeLayout不同，则会引发效率问题，当子View很复杂时，这个问题会更加严重。如果可以，尽量使用padding代替margin;</li>
<li>在不影响层级深度的情况下,使用LinearLayout和FrameLayout而不是RelativeLayout;</li>
<li>使用组合控件性能要好于两个独立控件，比如一个文本旁边有一个图片，这中情况最好要用DrawableLeft的这种属性设置图片;</li>
</ol>
<p><strong>2. 减少布局的层级结构</strong></p>
<ul>
<li>HierarchyViewer—可查看布局层次结构，View绘制时耗时。<br>
<a href="http://blog.csdn.net/xyz_lmn/article/details/14222975">HierarchyViewer的使用</a></li>
<li>无线UIViewer—强烈推荐App工具，可在手机端直接实现HierarchyViewer的功能，查看任意界面的UI布局。<br>
<a href="http://download.csdn.net/detail/duantihi/9448886">无线UIViewer下载</a></li>
</ul>
<p>总结：</p>
<ul>
<li>一些复用性很高的布局文件，比如一个App的标题栏，建议使用布局重用include标签，方便引入和共同管理。</li>
<li>观察上图第三个层级和第四个层级，无论是Layout类型，还是所覆盖的坐标点，都是重合的，因为父FrameLayout作为一个Container，子FrameLayout作为一个子View的跟布局，这种情况，可使用merge标签进行布局层级的优化。</li>
<li>有些在特定情况下才会出现的界面，比如联网之后，或者未必百分之百出现的界面，可用ViewStub标签进行懒加载，性能明显要优于加载出这个界面然后gone掉。</li>
</ul>
<p>布局优化相关网址：<br>
<a href="http://blog.csdn.net/xyz_lmn/article/details/14524567">三种优化标签的使用情景和优势—张业兴 </a><br>
<a href="http://www.it165.net/pro/html/201409/22192.html">布局优化标签的源码分析</a></p>
<p>有关布局优化的一些基础知识准备(郭霖老师的两篇博客)：<br>
<a href="http://blog.csdn.net/guolin_blog/article/details/12921889">Android LayoutInflater原理分析，带你一步步深入了解View(一)</a><br>
<a href="http://blog.csdn.net/guolin_blog/article/details/16330267">Android视图绘制流程完全解析，带你一步步深入了解View(二)</a></p>
<h3 id="二android开发者模式gpu过渡绘制">二：Android开发者模式—GPU过渡绘制</h3>
<p><strong>GPU过度绘制定义：</strong><br>
如果你粉刷过一个房间或一所房子，就会知道给墙壁涂上颜色需要做大量的工作。假如你还要重新粉刷一次的话，第二次粉刷的颜色会覆盖住第一次的颜色，第一次的颜色就永远不可见了，等于你第一次粉刷做的大量工作就完全被浪费掉。这太可怕了。</p>
<p>同样的道理，如果在你的应用程序中浪费精力去绘制一些东西同样会产生性能问题。过度绘制这个名词就是用来描述屏幕上一个像素在单个帧中被重绘了多少次。</p>
<p>GPU过度绘制就指的是在屏幕一个像素上绘制多次(超过一次)，GPU过度绘制或多或少对性能有些影响。</p>
<p><strong>GPU过度绘制分析：</strong><br>
过度绘制其实是一个性能和设计的交叉点。我们在设计上追求很华丽的视觉效果，但一般来说这种视觉效果会采用非常多的层叠组件来实现，这时候就会带来过度绘制的问题。我们再来看看具体显示在Android界面层级关系：</p>
<p>当我们来绘制一个界面时，会有一个windows，然后是建立Activity，在Activity里可以建立多个view，或view group，view也可以嵌套view。这些组件从上到下分布，上面的组件是可以被用户看见的，而在下面的组件是不可见的，但是我们依然要花很多时间去绘制那些不可见的组件，因为在某些时候，它也可能会显示出来。</p>
<p><strong>检测过度绘制：</strong><br>
设置-开发者选项-调试GPU过度绘制-显示过度绘制区域(过度渲染等，不同机器可能不同)</p>
<figure data-type="image" tabindex="1"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119191934.png" alt="" loading="lazy"></figure>
<p>测试的颜色标识含义：</p>
<figure data-type="image" tabindex="2"><img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119191952.png" alt="" loading="lazy"></figure>
<p>项目测试截图：<br>
<img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119192004.png" alt="" loading="lazy"></p>
<p>可以看到项目中并不存在太大问题，有关减少过度绘制的一些建议：</p>
<ul>
<li>
<p>太多重叠的背景<br>
这个问题其实最容易解决，建议前期在设计时尽量保持整体背景统一，另外开发可以检查你在布局和代码中设置的背景，有些背景是被隐藏在底下的，它永远不可能显示出来，这种没必要的背景一定要移除，因为它很可能会严重影响到app的性能。</p>
</li>
<li>
<p>太多重叠的view<br>
第一个建议是：使用ViewStub来加载一些不常用的布局，它是一个轻量级且默认不可见的视图，可以动态的加载一个布局，只有你用到这个重叠着的view的时候才加载，推迟加载的时间。第二个建议是：如果使用了类似viewpager+Fragment这样的组合或者有多个Fragment在一个界面上，需要控制Fragment的显示和隐藏，尽量使用动态地Inflation view，它的性能要比SetVisiblity好。</p>
</li>
<li>
<p>复杂的Layout层级<br>
这里的建议比较多一些，首先推荐用Android提供的布局工具Hierarchy</p>
</li>
</ul>
<h3 id="三android中耗电量的测试">三：Android中耗电量的测试</h3>
<p><a href="http://www.cnblogs.com/hyddd/p/4402621.html">深入浅出Android App耗电量统计</a></p>
<h3 id="四内存-cpu-gpu">四：内存、CPU、GPU</h3>
<p>应用运行时内存使用情况查看：Android Studio—Memory/CPU/GPU<br>
通常这种测试应该使用一个自动化工具（monkey）去不停的点击App，或者切换界面，来观察内存、cpu的情况。<br>
<strong>内存</strong><br>
测试截图：<br>
<img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119192015.png" alt="" loading="lazy"><br>
在地图界面不断地刷新，正常的内存成锯齿状分布。<br>
需要注意的情况：<br>
<img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119192025.png" alt="" loading="lazy"><br>
出现了针状分布，说明内存发生了突变，如果内存峰值不能降下来，就说明出现了内存溢出，就值得引起我们的关注了。</p>
<p><strong>CPU</strong><br>
<strong>GPU</strong><br>
Android Studio 1.4增加一项新功能：分析GPU渲染功能。作者详细讲解这一新功能的分析方法。<br>
在GPU选项卡下，可以在屏幕上看到图形化显示的渲染每帧所花费的时间。图形中每条都表示被渲染的一帧。颜色表示进程的不同周期：</p>
<p>绘画（蓝色）<br>
表示View#onDraw()方法。那部分建立/更改DisplayList对象，然后转换成GPU能够理解的OpenGL命令。高的条形可能是视图复杂，而要求更多的时间绘制它们的显示列表，而许多视图在短时间内就失效了。</p>
<p>准备（紫色）<br>
在Lollipop中，加入另一个线程，以帮助UI线程渲染更快。这个线程叫：RenderThread。它的责任是转换显示列表为OpenGL命令，再发送给GPU。这样在渲染过程中，UI线程可以开始处理下一个帧。这时UI线程将所有资源传送给RenderThread。如果有许多资源要传递（如许多/繁重显示列表），这一步可能需要较长时间。</p>
<p>处理（红色）<br>
执行显示列表产生OpenGL命令。由于需要视图重绘，如果有许多/复杂显示列表要执行转换，这一步可能需要较长时间。当视图无效或是移动时，都要要重绘视图。</p>
<p>执行（黄色）<br>
发送OpenGL命令到GPU。由于CPU发送这些缓存的命令到GPU，并期待收回干净缓存，这就阻塞调用了。缓存数量有限，并且GPU也很忙<br>
——<br>
CPU会发现自己必须先等待缓存释放。因此，如果在这一步我们见高的条形，就可能意味着GPU在绘制UI时非常忙，这个绘制在短时间内太复杂了。</p>
<p>测试截图：<br>
<img src="https://raw.githubusercontent.com/yeziblogpic/blogpic/master/20200119192037.png" alt="" loading="lazy"></p>
<p>结论：</p>
<p>可以通过切换界面，看图形的峰值和颜色去判断绘制View每个阶段所花费的时间，然后根据你的需求进行优化。</p>
<h3 id="五程序的执行效率">五：程序的执行效率</h3>
<ol>
<li>静态代码检查工具：Android studio—Analyze—Inspect Code…/Code cleanup… ，用于检测代码中潜在的问题、存在效率问题的代码段并提供改善方案；</li>
<li>DDMS—TraceView，用于查找程序运行时具体耗时在哪；</li>
<li>StrictMode：用于查找程序运行时具体耗时在哪，需要集成到代码中；</li>
</ol>
<h3 id="六知名的三方性能优化工具">六：知名的三方性能优化工具</h3>
<p>eakCanary<br>
LeakCanary是一个检测内存泄露的开源类库。你可以在 debug<br>
包种轻松检测内存泄露。强烈推荐LeakCanary，大多数公司都在使用它进行内存泄漏的测试。</p>
<p>以下是我找到的学习资料，写的非常棒：<br>
<a href="http://www.liaohuqiu.net/cn/posts/leak-canary/">LeakCanary:让内存泄露无所遁形</a><br>
<a href="http://www.liaohuqiu.net/cn/posts/leak-canary-read-me/">LeakCanary中文使用说明</a></p>
</div>
                              <div class="mdui-divider mdui-m-t-3"></div>
                              <div class="mdui-row-xs-2 mdui-m-t-2">
  <div class="mdui-col"> <div class="mdui-text-left"><a href="https://fqzhanghao.github.io/post/android-xi-tong-zhong-parcelable-he-serializable-de-qu-bie">Android系统中Parcelable和Serializable的区别</a></div></div>
 <div class="mdui-col"><div class="mdui-text-right "><a href="https://fqzhanghao.github.io/post/android-huan-fu-gong-neng-zhong-ru-he-dong-tai-huo-qu-kong-jian-zhong-bei-jing-tu-pian-de-zi-yuan-id">android换肤功能中，如何动态获取控件中背景图片的资源id？</a></div> </div>
                                </div>
                                <div class="mdui-divider mdui-m-t-2"></div>
   
 <script src="https://fqzhanghao.github.io//media/scripts/Valine.min.js"></script>
 <div class="comment"></div>

<script>
      new Valine({
            el: '.comment',



            path: window.location.pathname,
            pageSize: 30,
            avatar:'mm', 
       })

    </script> 
<script>
    if(window.location.hash){
        var checkExist = setInterval(function() {
           if ($(window.location.hash).length) {
              $('html, body').animate({scrollTop: $(window.location.hash).offset().top-90}, 1000);
              clearInterval(checkExist);
           }
        }, 100);
    }
</script>
                         </article>
                 <div class="toc-container mdui-float-right">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li>
<ul>
<li><a href="#%E9%9B%B6%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87">零：性能指标</a></li>
<li><a href="#%E4%B8%80%E5%B8%83%E5%B1%80%E5%A4%8D%E6%9D%82%E5%BA%A6%E7%9A%84%E4%BC%98%E5%8C%96">一：布局复杂度的优化</a></li>
<li><a href="#%E4%BA%8Candroid%E5%BC%80%E5%8F%91%E8%80%85%E6%A8%A1%E5%BC%8Fgpu%E8%BF%87%E6%B8%A1%E7%BB%98%E5%88%B6">二：Android开发者模式—GPU过渡绘制</a></li>
<li><a href="#%E4%B8%89android%E4%B8%AD%E8%80%97%E7%94%B5%E9%87%8F%E7%9A%84%E6%B5%8B%E8%AF%95">三：Android中耗电量的测试</a></li>
<li><a href="#%E5%9B%9B%E5%86%85%E5%AD%98-cpu-gpu">四：内存、CPU、GPU</a></li>
<li><a href="#%E4%BA%94%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%89%A7%E8%A1%8C%E6%95%88%E7%8E%87">五：程序的执行效率</a></li>
<li><a href="#%E5%85%AD%E7%9F%A5%E5%90%8D%E7%9A%84%E4%B8%89%E6%96%B9%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%B7%A5%E5%85%B7">六：知名的三方性能优化工具</a></li>
</ul>
</li>
</ul>
</li>
</ul>

              </div>

                        </div>
                 </div>
          
        </div>
        <script data-no-instant>
    (function ($) {
        $.extend({
            adamsOverload: function () {
                $.viewImage({
                    'target'  : '.post-neirong img',
                    'exclude' : '.vsmile-icons img , .song-links-item img',
                    'delay'   : 300
                });
            }
        });
    })(jQuery);
    jQuery.adamsOverload();
</script>
        <footer class="footer mdui-m-t-5 mdui-text-center">
               <nav class="social-links">
                      <ul>
                      
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                            
                           
                      </ul>
                    </nav>
                  <div class="copyright">
                      <p>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a></p>
                  </div>
              </footer>
    </body>
</html>